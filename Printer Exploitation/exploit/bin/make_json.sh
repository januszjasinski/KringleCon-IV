#!/bin/bash

# Clean up environment
find ../firmware_new/ -type f -exec rm {} \;
find ../result/ -type f -exec rm {} \;
cp -p ../firmware_original/firmware.zip ../firmware_new/firmware.zip

# Freshen the zip archive with new firmware.bin
zip -j -f ../firmware_new/firmware.zip ../payload/firmware.bin
# Store new firmware.zip archive as hex string
HEXZIP=$(xxd -p ../firmware_new/firmware.zip | tr -d "\n")

# Run hash_extender and store the result
RESULT=$(./hash_extender --file=../firmware_original/firmware.zip --secret=16 --append-format=hex --append=$HEXZIP --signature=e0b5855c6dd61ceb1e0ae694e68f16a74adb6f87d1e9e2f78adfee688babcf23 --format=sha256)

# Extract firmware and signature
RES_SIG=$(echo $RESULT | awk '{print $8}')
RES_STRING=$(echo $RESULT | awk '{print $11}' | xxd -r -p - | base64 -w0 -)

# Create new firmware json file
echo -n "{\"firmware\":\"$RES_STRING\",\"signature\":\"$RES_SIG\",\"secret_length\":16,\"algorithm\":\"SHA256\"}" > ../result/firmware-export.json